<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Detector de Sono</title>
  <style>
    body { margin: 0; }
    video {
      transform: scaleX(-1);
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
  </style>
</head>
<body>

<video id="video" autoplay playsinline></video>

<audio id="alarm" loop>
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("video");
const alarm = document.getElementById("alarm");

// ===== CONFIGURAÇÕES =====
const EAR_LIMITE = 0.015;
const TEMPO_OLHOS_FECHADOS = 3 * 60 * 1000; // 3 minutos
const TEMPO_TIMER = 3 * 60 * 60 * 1000;     // 3 horas

// ===== ESTADO =====
let olhosFechadosInicio = null;
let timerIniciado = false;

// ===== FUNÇÃO EAR =====
function distancia(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

function calcularEAR(p1, p2, p3, p4, p5, p6) {
  return (
    distancia(p2, p6) + distancia(p3, p5)
  ) / (2 * distancia(p1, p4));
}

// ===== FACE MESH =====
const faceMesh = new FaceMesh({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true
});

faceMesh.onResults(results => {
  if (!results.multiFaceLandmarks) return;

  const lm = results.multiFaceLandmarks[0];

  // Olho esquerdo
  const ear = calcularEAR(
    lm[33], lm[160], lm[158],
    lm[133], lm[153], lm[144]
  );

  // ===== LÓGICA PRINCIPAL =====
  if (ear < EAR_LIMITE) {
    if (!olhosFechadosInicio) {
      olhosFechadosInicio = Date.now();
    }

    const tempoFechado = Date.now() - olhosFechadosInicio;

    if (tempoFechado >= TEMPO_OLHOS_FECHADOS && !timerIniciado) {
      timerIniciado = true;
      console.log("Dormiu! Timer de 3 horas iniciado.");

      setTimeout(() => {
        alarm.play();
        alert("⏰ Hora de acordar para o sonho lúcido!");
      }, TEMPO_TIMER);
    }

  } else {
    // Olhos abriram antes de completar 3 min → reset
    olhosFechadosInicio = null;
  }
});

// ===== CAMERA =====
const camera = new Camera(video, {
  onFrame: async () => {
    await faceMesh.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();
</script>

</body>
</html>